---
import { getPath } from '../utils/path';

interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  loading?: 'lazy' | 'eager';
  class?: string;
  sizes?: string;
  fallback?: string;
}

const { 
  src, 
  alt, 
  width, 
  height, 
  loading = 'lazy',
  class: className = '',
  sizes = '(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw',
  fallback
} = Astro.props;

// Converti path WordPress a path locale
let localSrc = src;
if (src.includes('wp-content/uploads')) {
  const match = src.match(/wp-content\/uploads\/(.+)/);
  if (match) {
    localSrc = getPath(`media/uploads/${match[1].split('?')[0]}`);
  }
} else if (src.startsWith('http')) {
  // Se è un URL esterno, lascialo così
  localSrc = src;
} else if (src.startsWith('/media/') || src.startsWith('media/')) {
  // Path locale relativo - usa getPath
  localSrc = getPath(src.replace(/^\/+/, ''));
}

// Genera srcset per responsive images (se width è specificato)
let srcset = '';
if (width && localSrc.includes('/media/uploads/')) {
  // Cerca versioni ridimensionate (pattern WordPress: nome-300x200.jpg)
  const basePath = localSrc.replace(/-\d+x\d+\.(jpg|jpeg|png|gif)$/i, '');
  const ext = localSrc.split('.').pop();
  
  // Genera srcset con dimensioni comuni
  const sizes = [300, 600, 1024, 1920];
  srcset = sizes
    .filter(s => s <= (width || 1920))
    .map(s => `${basePath}-${s}x${Math.round(s * (height || 1) / (width || 1))}.${ext} ${s}w`)
    .join(', ');
}
---

<img 
  src={localSrc}
  alt={alt}
  width={width}
  height={height}
  loading={loading}
  class={className}
  {srcset ? { srcset } : null}
  sizes={srcset ? sizes : undefined}
  decoding="async"
  style={width && height ? `aspect-ratio: ${width} / ${height};` : undefined}
  {fallback ? { 'data-fallback': fallback } : null}
/>

{fallback && (
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const img = document.currentScript?.previousElementSibling as HTMLImageElement;
      if (img && img.dataset.fallback) {
        img.addEventListener('error', () => {
          img.src = img.dataset.fallback || '';
        });
      }
    });
  </script>
)}

