---
import { marked } from 'marked';
import { getPath } from '../utils/path';

interface Props {
  content: string;
}

const { content } = Astro.props;

// Configure marked
marked.setOptions({
  breaks: true,
  gfm: true,
  headerIds: false,
  mangle: false,
});

// Convert absolute URLs to relative paths
function normalizeLinks(md: string): string {
  // Replace absolute URLs with relative paths
  let normalized = md.replace(
    /https?:\/\/europolinvestigazioni\.it\//g,
    '/'
  );
  
  // Remove empty links [](url)
  normalized = normalized.replace(/\[\]\([^)]+\)/g, '');
  
  return normalized;
}

// Normalize content before parsing
const normalizedContent = normalizeLinks(content);

// Convert markdown to HTML (allow HTML in markdown)
let htmlContent = marked.parse(normalizedContent, {
  breaks: true,
  gfm: true,
});

// Process images and links to add BASE_URL
const base = import.meta.env.BASE_URL || '';
if (base) {
  // Process img tags in HTML content
  htmlContent = htmlContent.replace(
    /<img([^>]*src=["'])([^"']+)(["'][^>]*)>/gi,
    (match, before, src, after) => {
      // Skip if already has base URL or is external URL
      if (src.startsWith('http://') || src.startsWith('https://') || src.startsWith(base)) {
        return match;
      }
      
      // Add base URL to local paths
      if (src.startsWith('/media/') || src.startsWith('media/')) {
        const cleanSrc = src.replace(/^\/+/, '');
        const newSrc = getPath(cleanSrc);
        return `<img${before}${newSrc}${after}>`;
      }
      
      return match;
    }
  );
  
  // Process internal links (a tags) to add BASE_URL
  htmlContent = htmlContent.replace(
    /<a([^>]*href=["'])([^"']+)(["'][^>]*)>/gi,
    (match, before, href, after) => {
      // Skip if already has base URL or is external URL
      if (href.startsWith('http://') || href.startsWith('https://') || href.startsWith('mailto:') || href.startsWith('#') || href.startsWith(base)) {
        return match;
      }
      
      // Add base URL to internal paths (starting with /)
      if (href.startsWith('/')) {
        const cleanHref = href.replace(/^\/+/, '');
        const newHref = getPath(cleanHref);
        return `<a${before}${newHref}${after}>`;
      }
      
      return match;
    }
  );
}
---

<div class="prose prose-lg max-w-none prose-headings:font-bold prose-strong:font-semibold prose-ul:list-disc prose-ol:list-decimal" style="--tw-prose-headings: var(--color-black); --tw-prose-links: var(--color-black); --tw-prose-body: var(--color-text);" set:html={htmlContent} />

